{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-cog me-2"></i>Admin Dashboard</h2>
        <p class="text-muted">Analytics and user activity overview</p>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('visualizations') }}" class="btn btn-outline-primary">
            <i class="fas fa-chart-pie me-2"></i>Awareness Visualizations
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-users me-2"></i>Total Users</h5>
                <h2 class="card-text">{{ total_users }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-question-circle me-2"></i>Total Quizzes</h5>
                <h2 class="card-text">{{ total_quizzes }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Total Activities</h5>
                <h2 class="card-text">{{ total_activities }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-users me-2"></i>User Statistics</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Total Quiz Attempts</th>
                                <th>Average Score</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in user_stats %}
                            <tr>
                                <td>{{ stat.username }}</td>
                                <td>{{ stat.total_attempts }}</td>
                                <td>
                                    {% if stat.avg_score > 0 %}
                                    <span class="badge {% if stat.avg_score >= 70 %}bg-success{% elif stat.avg_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ "%.1f"|format(stat.avg_score) }}%
                                    </span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if stat.last_activity %}
                                    {{ stat.last_activity.created_at | localtime }}
                                    {% else %}
                                    <span class="text-muted">No activity</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-clock me-2"></i>Recent Activities</h5>
            </div>
            <div class="card-body">
                {% if recent_activities %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Activity Type</th>
                                    <th>Description</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in recent_activities %}
                                <tr>
                                    <td>{{ activity.user.username }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ activity.activity_type }}</span>
                                    </td>
                                    <td>{{ activity.description }}</td>
                                    <td>{{ activity.created_at | localtime }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No recent activities.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-chart-line me-2"></i>Daily Activity Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="dailyActivityChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-tasks me-2"></i>Activity Breakdown</h5>
            </div>
            <div class="card-body">
                <canvas id="activityTypeChart" height="220"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-bullseye me-2"></i>Quiz Performance Over Time</h5>
            </div>
            <div class="card-body">
                <canvas id="quizPerformanceChart" height="180"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-layer-group me-2"></i>Quiz Type Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="quizTypeChart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-secondary text-white">
                <h5><i class="fas fa-signal me-2"></i>Score Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="scoreDistributionChart" height="180"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-trophy me-2"></i>Top Performers</h5>
            </div>
            <div class="card-body">
                <canvas id="topUsersChart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-cog me-2"></i>Model Management</h5>
            </div>
            <div class="card-body">
                <p>Update the ML model with latest survey data:</p>
                <button class="btn btn-warning" onclick="updateMLModel()">
                    <i class="fas fa-sync me-2"></i>Retrain ML Model
                </button>
                <div id="modelUpdateStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const colorPalette = [
    '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f',
    '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'
];

fetch('{{ url_for("analytics") }}')
    .then(response => response.json())
    .then(data => {
        const sortedActivityDates = Object.keys(data.daily_activity).sort();
        const dailyActivityValues = sortedActivityDates.map(d => data.daily_activity[d]);
        new Chart(document.getElementById('dailyActivityChart'), {
            type: 'line',
            data: {
                labels: sortedActivityDates,
                datasets: [{
                    label: 'Total Activities',
                    data: dailyActivityValues,
                    borderColor: '#4e79a7',
                    backgroundColor: 'rgba(78, 121, 167, 0.2)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        const activityTypes = Object.keys(data.activity_type_counts);
        const activityCounts = activityTypes.map(type => data.activity_type_counts[type]);
        new Chart(document.getElementById('activityTypeChart'), {
            type: 'doughnut',
            data: {
                labels: activityTypes,
                datasets: [{
                    data: activityCounts,
                    backgroundColor: colorPalette.slice(0, activityTypes.length)
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        const sortedPerfDates = Object.keys(data.quiz_performance).sort();
        const perfValues = sortedPerfDates.map(d => data.quiz_performance[d]);
        new Chart(document.getElementById('quizPerformanceChart'), {
            type: 'line',
            data: {
                labels: sortedPerfDates,
                datasets: [{
                    label: 'Average %',
                    data: perfValues,
                    borderColor: '#59a14f',
                    backgroundColor: 'rgba(89, 161, 79, 0.2)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        const quizTypes = Object.keys(data.quiz_type_distribution);
        const quizTypeCounts = quizTypes.map(type => data.quiz_type_distribution[type]);
        new Chart(document.getElementById('quizTypeChart'), {
            type: 'pie',
            data: {
                labels: quizTypes,
                datasets: [{
                    data: quizTypeCounts,
                    backgroundColor: colorPalette.slice(0, quizTypes.length)
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        const scoreLevels = Object.keys(data.score_distribution);
        const scoreCounts = scoreLevels.map(level => data.score_distribution[level]);
        new Chart(document.getElementById('scoreDistributionChart'), {
            type: 'bar',
            data: {
                labels: scoreLevels,
                datasets: [{
                    label: 'Users',
                    data: scoreCounts,
                    backgroundColor: '#edc949'
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } }
            }
        });

        const topUsers = data.top_users || [];
        new Chart(document.getElementById('topUsersChart'), {
            type: 'bar',
            data: {
                labels: topUsers.map(u => u.username),
                datasets: [{
                    label: 'Average %',
                    data: topUsers.map(u => u.avg_score),
                    backgroundColor: '#e15759'
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true, max: 100 }
                }
            }
        });
    })
    .catch(error => console.error('Error loading analytics:', error));

// Update ML Model
function updateMLModel() {
    const statusDiv = document.getElementById('modelUpdateStatus');
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Retraining model... This may take a moment.</div>';
    
    fetch('{{ url_for("update_model") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Model updated successfully!</div>';
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${data.error || 'Unknown error'}</div>`;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}</div>`;
    });
}
</script>
{% endblock %}

