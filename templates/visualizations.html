{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="fas fa-chart-pie me-2"></i>Awareness Index Visualizations</h2>
            <p class="text-muted mb-0">Insights generated from the Project Survey responses.</p>
        </div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Admin Dashboard
        </a>
    </div>
</div>

{% if not data_available %}
    <div class="alert alert-warning">
        <i class="fas fa-info-circle me-2"></i>
        Survey file not found. Please place <code>survey_data_backup.csv</code> or <code>Project Survey (Responses).xlsx</code> in the project root.
    </div>
{% else %}
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-white-50">Respondents</h6>
                <h3 class="mb-0">{{ summary.respondent_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-white-50">Average Score</h6>
                <h3 class="mb-0">{{ summary.average_score }}%</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-info h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-white-50">Median Score</h6>
                <h3 class="mb-0">{{ summary.median_score }}%</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-white-50">High Awareness</h6>
                <h3 class="mb-0">{{ summary.high_percentage }}%</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-signal me-2"></i>Knowledge Score Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="scoreDistributionChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Knowledge Trend Over Time</h5>
            </div>
            <div class="card-body">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Average Score by Age Range</h5>
            </div>
            <div class="card-body">
                <canvas id="ageChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-venus-mars me-2"></i>Average Score by Gender</h5>
            </div>
            <div class="card-body">
                <canvas id="genderChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-4 mb-4">
        <div class="card h-100 shadow">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-book-reader me-2"></i>Privacy Policy Reading Habits</h5>
            </div>
            <div class="card-body">
                <canvas id="privacyChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card h-100 shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>App Permission Reviews</h5>
            </div>
            <div class="card-body">
                <canvas id="permissionsChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card h-100 shadow">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-key me-2"></i>Password Practices</h5>
            </div>
            <div class="card-body">
                <canvas id="passwordChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if data_available %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const dataScoreDistribution = {{ score_distribution | safe }};
const dataAvgByAge = {{ avg_by_age | safe }};
const dataAvgByGender = {{ avg_by_gender | safe }};
const dataPrivacyCounts = {{ privacy_policy_counts | safe }};
const dataPermissionsCounts = {{ permissions_counts | safe }};
const dataPasswordCounts = {{ password_counts | safe }};
const dataTimeline = {{ timeline | safe }};

const palette = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ab'];

function buildBarChart(ctxId, labels, values, color='#4e79a7', horizontal=false) {
    return new Chart(document.getElementById(ctxId), {
        type: horizontal ? 'bar' : 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Score (%)',
                data: values,
                backgroundColor: color
            }]
        },
        options: {
            responsive: true,
            indexAxis: horizontal ? 'y' : 'x',
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
}

new Chart(document.getElementById('scoreDistributionChart'), {
    type: 'doughnut',
    data: {
        labels: Object.keys(dataScoreDistribution),
        datasets: [{
            data: Object.values(dataScoreDistribution),
            backgroundColor: palette.slice(0, 3)
        }]
    },
    options: { responsive: true }
});

new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: {
        labels: dataTimeline.map(item => item.date),
        datasets: [{
            label: 'Average Knowledge Score',
            data: dataTimeline.map(item => item.score),
            borderColor: '#59a14f',
            backgroundColor: 'rgba(89,161,79,0.2)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true, max: 100 }
        }
    }
});

buildBarChart('ageChart', Object.keys(dataAvgByAge), Object.values(dataAvgByAge), '#4e79a7');
buildBarChart('genderChart', Object.keys(dataAvgByGender), Object.values(dataAvgByGender), '#af7aa1');

new Chart(document.getElementById('privacyChart'), {
    type: 'pie',
    data: {
        labels: Object.keys(dataPrivacyCounts),
        datasets: [{
            data: Object.values(dataPrivacyCounts),
            backgroundColor: palette.slice(0, Object.keys(dataPrivacyCounts).length)
        }]
    }
});

new Chart(document.getElementById('permissionsChart'), {
    type: 'pie',
    data: {
        labels: Object.keys(dataPermissionsCounts),
        datasets: [{
            data: Object.values(dataPermissionsCounts),
            backgroundColor: palette.slice(0, Object.keys(dataPermissionsCounts).length)
        }]
    }
});

new Chart(document.getElementById('passwordChart'), {
    type: 'pie',
    data: {
        labels: Object.keys(dataPasswordCounts),
        datasets: [{
            data: Object.values(dataPasswordCounts),
            backgroundColor: palette.slice(0, Object.keys(dataPasswordCounts).length)
        }]
    }
});
</script>
{% endif %}
{% endblock %}

