{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-book me-2"></i>Manage Learning Resources</h2>
        <p class="text-muted">Add, edit, or delete learning resources for users.</p>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('home') }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-2"></i>Back to Home
        </a>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addResourceModal">
            <i class="fas fa-plus me-2"></i>Add Resource
        </button>
    </div>
</div>

<!-- Resources Table -->
<div class="card shadow">
    <div class="card-header bg-info text-white">
        <h5><i class="fas fa-list me-2"></i>All Resources ({{ resources|length }})</h5>
    </div>
    <div class="card-body">
        {% if resources %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>URL</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resource in resources %}
                    <tr>
                        <td>{{ resource.id }}</td>
                        <td>
                            <strong>{{ resource.title }}</strong>
                            {% if resource.description %}
                            <br><small class="text-muted">{{ resource.description[:60] }}{% if resource.description|length > 60 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-secondary">{{ resource.resource_type }}</span></td>
                        <td><small>{{ resource.category or 'N/A' }}</small></td>
                        <td>
                            {% if resource.url %}
                            <a href="{{ resource.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> Open
                            </a>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td><small>{{ resource.created_at | localtime_date }}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editResource({{ resource.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteResource({{ resource.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>No resources found. Add your first resource!
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Resource Modal -->
<div class="modal fade" id="addResourceModal" tabindex="-1" aria-labelledby="addResourceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="addResourceModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Learning Resource
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="resourceForm">
                    <input type="hidden" id="resource_id" value="">
                    <div class="mb-3">
                        <label for="resource_title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="resource_title" required>
                    </div>
                    <div class="mb-3">
                        <label for="resource_description" class="form-label">Description</label>
                        <textarea class="form-control" id="resource_description" rows="3" placeholder="Brief description of the resource"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="resource_url" class="form-label">URL *</label>
                            <input type="url" class="form-control" id="resource_url" placeholder="https://..." required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="resource_type" class="form-label">Type</label>
                            <select class="form-select" id="resource_type">
                                <option value="article">Article</option>
                                <option value="video">Video</option>
                                <option value="course">Course</option>
                                <option value="tutorial">Tutorial</option>
                                <option value="documentation">Documentation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="resource_category" class="form-label">Category</label>
                            <input type="text" class="form-control" id="resource_category" placeholder="e.g., Privacy, Security">
                        </div>
                    </div>
                    <div id="resourceFormStatus"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="submitResource()">
                    <i class="fas fa-save me-2"></i><span id="submitButtonText">Add Resource</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editResource(resourceId) {
    fetch(`/admin/resources/${resourceId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('resource_id').value = data.id;
            document.getElementById('resource_title').value = data.title;
            document.getElementById('resource_description').value = data.description || '';
            document.getElementById('resource_url').value = data.url || '';
            document.getElementById('resource_type').value = data.resource_type || 'article';
            document.getElementById('resource_category').value = data.category || '';
            document.getElementById('addResourceModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Resource';
            document.getElementById('submitButtonText').textContent = 'Update Resource';
            new bootstrap.Modal(document.getElementById('addResourceModal')).show();
        })
        .catch(error => {
            alert('Error loading resource: ' + error.message);
        });
}

function deleteResource(resourceId) {
    if (!confirm('Are you sure you want to delete this resource?')) {
        return;
    }
    
    fetch(`/admin/resources/${resourceId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function submitResource() {
    const statusDiv = document.getElementById('resourceFormStatus');
    const form = document.getElementById('resourceForm');
    const resourceId = document.getElementById('resource_id').value;
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const resourceData = {
        title: document.getElementById('resource_title').value,
        description: document.getElementById('resource_description').value,
        url: document.getElementById('resource_url').value,
        resource_type: document.getElementById('resource_type').value,
        category: document.getElementById('resource_category').value
    };
    
    const url = resourceId ? `/admin/resources/${resourceId}/edit` : '{{ url_for("add_resource") }}';
    
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Saving...</div>';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(resourceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Resource saved successfully!</div>';
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${data.error || 'Unknown error'}</div>`;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}</div>`;
    });
}

// Reset modal on close
document.getElementById('addResourceModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('resourceForm').reset();
    document.getElementById('resource_id').value = '';
    document.getElementById('resourceFormStatus').innerHTML = '';
    document.getElementById('addResourceModalLabel').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add New Learning Resource';
    document.getElementById('submitButtonText').textContent = 'Add Resource';
});
</script>
{% endblock %}

