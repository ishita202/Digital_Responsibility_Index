{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-question-circle me-2"></i>Manage Quiz Questions</h2>
        <p class="text-muted">Add, edit, or delete quiz questions for all quiz types.</p>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('home') }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-2"></i>Back to Home
        </a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
            <i class="fas fa-plus me-2"></i>Add Question
        </button>
    </div>
</div>

<!-- Questions Table -->
<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <h5><i class="fas fa-list me-2"></i>All Questions ({{ questions|length }})</h5>
    </div>
    <div class="card-body">
        {% if questions %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Question</th>
                        <th>Quiz Type</th>
                        <th>Category</th>
                        <th>Difficulty</th>
                        <th>Time Limit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for question in questions %}
                    <tr>
                        <td>{{ question.id }}</td>
                        <td>
                            <strong>{{ question.question_text[:80] }}{% if question.question_text|length > 80 %}...{% endif %}</strong>
                        </td>
                        <td><span class="badge bg-info">{{ question.quiz_type }}</span></td>
                        <td><small>{{ question.category or 'N/A' }}</small></td>
                        <td>
                            <span class="badge {% if question.difficulty == 'Easy' %}bg-success{% elif question.difficulty == 'Medium' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ question.difficulty }}
                            </span>
                        </td>
                        <td><small>{{ question.time_limit }}s</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editQuestion({{ question.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion({{ question.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>No questions found. Add your first question!
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1" aria-labelledby="addQuestionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addQuestionModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Quiz Question
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="questionForm">
                    <input type="hidden" id="question_id" value="">
                    <div class="mb-3">
                        <label for="question_text" class="form-label">Question Text *</label>
                        <textarea class="form-control" id="question_text" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="option_a" class="form-label">Option A *</label>
                            <input type="text" class="form-control" id="option_a" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="option_b" class="form-label">Option B *</label>
                            <input type="text" class="form-control" id="option_b" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="option_c" class="form-label">Option C *</label>
                            <input type="text" class="form-control" id="option_c" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="option_d" class="form-label">Option D *</label>
                            <input type="text" class="form-control" id="option_d" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="correct_answer" class="form-label">Correct Answer *</label>
                            <select class="form-select" id="correct_answer" required>
                                <option value="">Select...</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="quiz_type" class="form-label">Quiz Type *</label>
                            <select class="form-select" id="quiz_type" required>
                                {% for qt in quiz_types %}
                                <option value="{{ qt.name }}">{{ qt.name }}</option>
                                {% endfor %}
                                <option value="General">General</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="difficulty" class="form-label">Difficulty</label>
                            <select class="form-select" id="difficulty">
                                <option value="Easy">Easy</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category</label>
                            <input type="text" class="form-control" id="category" placeholder="e.g., Privacy, Security">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="time_limit" class="form-label">Time Limit (seconds)</label>
                            <input type="number" class="form-control" id="time_limit" value="60" min="10" max="300">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="explanation" class="form-label">Explanation</label>
                        <textarea class="form-control" id="explanation" rows="2" placeholder="Optional explanation for the answer"></textarea>
                    </div>
                    <div id="questionFormStatus"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitQuestion()">
                    <i class="fas fa-save me-2"></i><span id="submitButtonText">Add Question</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editQuestion(questionId) {
    // Fetch question data and populate form
    fetch(`/admin/questions/${questionId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('question_id').value = data.id;
            document.getElementById('question_text').value = data.question_text;
            document.getElementById('option_a').value = data.option_a;
            document.getElementById('option_b').value = data.option_b;
            document.getElementById('option_c').value = data.option_c;
            document.getElementById('option_d').value = data.option_d;
            document.getElementById('correct_answer').value = data.correct_answer;
            document.getElementById('quiz_type').value = data.quiz_type;
            document.getElementById('category').value = data.category || '';
            document.getElementById('difficulty').value = data.difficulty;
            document.getElementById('time_limit').value = data.time_limit;
            document.getElementById('explanation').value = data.explanation || '';
            document.getElementById('addQuestionModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Question';
            document.getElementById('submitButtonText').textContent = 'Update Question';
            new bootstrap.Modal(document.getElementById('addQuestionModal')).show();
        })
        .catch(error => {
            alert('Error loading question: ' + error.message);
        });
}

function deleteQuestion(questionId) {
    if (!confirm('Are you sure you want to delete this question?')) {
        return;
    }
    
    fetch(`/admin/questions/${questionId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function submitQuestion() {
    const statusDiv = document.getElementById('questionFormStatus');
    const form = document.getElementById('questionForm');
    const questionId = document.getElementById('question_id').value;
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const questionData = {
        question_text: document.getElementById('question_text').value,
        option_a: document.getElementById('option_a').value,
        option_b: document.getElementById('option_b').value,
        option_c: document.getElementById('option_c').value,
        option_d: document.getElementById('option_d').value,
        correct_answer: document.getElementById('correct_answer').value,
        quiz_type: document.getElementById('quiz_type').value,
        category: document.getElementById('category').value,
        difficulty: document.getElementById('difficulty').value,
        time_limit: parseInt(document.getElementById('time_limit').value),
        explanation: document.getElementById('explanation').value
    };
    
    const url = questionId ? `/admin/questions/${questionId}/edit` : '{{ url_for("add_question") }}';
    const method = 'POST';
    
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Saving...</div>';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(questionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Question saved successfully!</div>';
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${data.error || 'Unknown error'}</div>`;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}</div>`;
    });
}

// Reset modal on close
document.getElementById('addQuestionModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('questionForm').reset();
    document.getElementById('question_id').value = '';
    document.getElementById('questionFormStatus').innerHTML = '';
    document.getElementById('addQuestionModalLabel').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add New Quiz Question';
    document.getElementById('submitButtonText').textContent = 'Add Question';
});
</script>
{% endblock %}

